#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <HardwareSerial.h>

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª WiFi
const char* ssid = "Baraa-2.4G-c45Y";
const char* password = "Baraa2001";

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª
String BOT_TOKEN = "7012424165:AAGyCrQOo3CtKPD5XC1HfSUf03F3e4ukdB4";
String CHAT_ID = "7415395031";

// GPS Ø¹Ø¨Ø± SIM808
HardwareSerial sim808(1);  // UART1: RX=16, TX=17

// MPU6050
const int MPU_ADDR = 0x68;
int16_t ax, ay, az, gx, gy, gz;

// Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª
#define IN1 26
#define IN2 27
#define ENA 25

#define IN3 14
#define IN4 12
#define ENB 33

// Ø§Ù„Ø­Ø³Ø§Ø³ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ
#define trig1 4
#define echo1 5

// Ø§Ù„Ø­Ø³Ø§Ø³ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
#define trig2 18
#define echo2 19

// Ø§Ù„Ø¨Ø²Ø±
#define buzzerPin 23

void setup() {
  Serial.begin(115200);

  // WiFi
  WiFi.begin(ssid, password);
  Serial.print("Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø¨ÙƒØ© WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„!");

  // MPU6050
  Wire.begin();
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x6B);
  Wire.write(0);
  Wire.endTransmission(true);

  // SIM808
  sim808.begin(9600, SERIAL_8N1, 16, 17);
  delay(2000);
  sim808.println("AT+CGNSPWR=1");
  delay(1000);

  // Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(ENA, OUTPUT);

  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(ENB, OUTPUT);

  digitalWrite(ENA, HIGH);
  digitalWrite(ENB, HIGH);

  // Ø§Ù„Ø§Ù„ØªØ±Ø§Ø³ÙˆÙ†Ùƒ
  pinMode(trig1, OUTPUT); pinMode(echo1, INPUT);
  pinMode(trig2, OUTPUT); pinMode(echo2, INPUT);

  // Ø§Ù„Ø¨Ø²Ø±
  pinMode(buzzerPin, OUTPUT);

  Serial.println("Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­ÙƒÙ… ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...");
}

void loop() {
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬ÙŠØ±ÙˆØ³ÙƒÙˆØ¨
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x43);
  Wire.endTransmission(false);
  Wire.requestFrom(MPU_ADDR, 6, true);
  gx = (Wire.read() << 8) | Wire.read();
  gy = (Wire.read() << 8) | Wire.read();
  gz = (Wire.read() << 8) | Wire.read();

  float gz_deg = gz / 131.0;
  Serial.print("GZ: "); Serial.println(gz_deg);

  if (gz_deg > 100 || gz_deg < -100) {
    float lat, lon;
    String timeStr;
    getGPSData(lat, lon, timeStr);

    String message = "âš ï¸ Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¯Ø«!\n";
    message += "ğŸ“ https://maps.google.com/?q=" + String(lat, 6) + "," + String(lon, 6) + "\n";
    message += "ğŸ•’ " + timeStr;

    sendTelegram(message);
    delay(10000);
  }

  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø§Ù„ØªØ±Ø§Ø³ÙˆÙ†Ùƒ
  float distance1 = readDistanceCM(trig1, echo1);
  float distance2 = readDistanceCM(trig2, echo2);

  Serial.print("Front: ");
  Serial.print(distance1);
  Serial.print(" cm\tSide: ");
  Serial.println(distance2);

  if (distance1 < 20 || distance2 < 20) {
    digitalWrite(buzzerPin, HIGH);
  } else {
    digitalWrite(buzzerPin, LOW);
  }

  // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª
  if (Serial.available()) {
    char cmd = Serial.read();
    switch (cmd) {
      case 'F':
        digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
        digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
        break;
      case 'B':
        digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
        digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
        break;
      case 'L':
        digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
        digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
        break;
      case 'R':
        digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
        digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
        break;
      case 'S':
        digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
        digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
        break;
    }
  }

  delay(300);
}

float readDistanceCM(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  long duration = pulseIn(echoPin, HIGH, 30000);
  return duration * 0.034 / 2;
}

void getGPSData(float &lat, float &lon, String &timestamp) {
  sim808.println("AT+CGNSINF");
  delay(1000);
  String gpsData = readResponse();

  int start = gpsData.indexOf("+CGNSINF:") + 10;
  String data = gpsData.substring(start);

  int commas[6], count = 0;
  for (int i = 0; i < data.length() && count < 6; i++) {
    if (data.charAt(i) == ',') commas[count++] = i;
  }

  lat = data.substring(commas[2] + 1, commas[3]).toFloat();
  lon = data.substring(commas[3] + 1, commas[4]).toFloat();

  String rawTime = data.substring(commas[1] + 1, commas[2]);
  if (rawTime.length() >= 14) {
    int hour = rawTime.substring(8, 10).toInt() + 3;
    if (hour >= 24) hour -= 24;
    timestamp = rawTime.substring(6, 8) + "-" + rawTime.substring(4, 6) + "-" + rawTime.substring(0, 4)
              + " Ø§Ù„Ø³Ø§Ø¹Ø© " + String(hour) + ":" + rawTime.substring(10, 12);
  } else {
    timestamp = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
  }
}

String readResponse() {
  String response = "";
  unsigned long timeout = millis() + 3000;
  while (millis() < timeout) {
    while (sim808.available()) {
      response += char(sim808.read());
    }
  }
  return response;
}

void sendTelegram(String msg) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    String url = "https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage?chat_id=" + CHAT_ID + "&text=" + urlencode(msg);
    http.begin(url);
    int httpCode = http.GET();
    if (httpCode > 0) {
      Serial.println("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…");
    } else {
      Serial.println("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
    }
    http.end();
  }
}

String urlencode(String str) {
  String encoded = "";
  char c;
  char code0, code1;
  for (int i = 0; i < str.length(); i++) {
    c = str.charAt(i);
    if (isalnum(c)) {
      encoded += c;
    } else {
      code0 = (c >> 4) & 0xF;
      code1 = c & 0xF;
      encoded += '%';
      encoded += char(code0 < 10 ? code0 + '0' : code0 - 10 + 'A');
      encoded += char(code1 < 10 ? code1 + '0' : code1 - 10 + 'A');
    }
  }
  return encoded;
}